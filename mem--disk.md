# 内存及磁盘相关

---

## 内存相关

内存是影响Linux性能的主要因素之一，通常出现的问题都与内存资源是否充足有关。

在Linux操作系统中，所以空余内存空间可以认为是free内存+buffer内存+cache内存，当内存不够的时候，则需要将内存中的数据换出到磁盘上的swap区域中，而内存的换入换出则意味着大量的磁盘IO调用。按照经验数据，当空余内存小于20%的时候，将会出频繁的内存换入换出，此时整个系统的性能将会急剧下降，很多服务和应用的响应时间会被拉长，甚至出现OOM而杀死进程的情况。如果出现类似的情况则明显需要增加内存。

同时每个进程可使用的内存大小也是可以配置的，这样我们就可以防止出现某些异常的进程大量占用内存不进行释放而带来内存不足的问题，配置文件位于/etc/security/limits.conf，如下的内容将会限制用户bob的进程仅可以使用15KB内存，用户组alice的进程只能使用20KB内存：

```shell
$ cat /etc/security/limits.conf
...
bob    hard    rss    15000
@alice hard    rss    20000
```

用户可以使用ulimit -a来查看自己的限制。

### OOM

当出现了内存不足的情况下，可能会导致OOM的情况，OOM是out of memory的缩写，虽然linux kernel有很多的内存管理技巧来满足各种应用空间的内存需求，但是当系统配置不合理的时候，linux kernel会运行非常缓慢并且在某个时间点分配page frame的时候遇到内存耗尽、无法分配的状况，此时系统会有两种处理情况：

1. 产生kernel panic
2. 选择几个最“适合”的进程，启用oom-killer，释放内存

sysctl\_panic\_on\_oom内核参数的配置就是针对这种情况下两种不同的动作而存在的，动态路径为/proc/sys/vm/panic\_on\_oom。

如果选择第二种方式，那么就引入了一个新的问题，系统如何决定应该杀死哪个进程或哪几个进程呢？
参数sysctl\oom\_kill\_allocating\_task负责管理这种情形下的动作，为0表示杀掉内存占用最多的进程，为1则表示杀掉触发OOM的进程。

推荐[参考链接](http://www.wowotech.net/memory_management/oom.html)，这里提到了更多的细节的选择，包括oom-killer之后是否生成dump文件，有多个进程关联的时候如何选择等。

## 磁盘相关

当应用程序在执行过程中需要依赖磁盘IO而完成一系列动作的时候，磁盘本身的性能、服务器对磁盘使用的配置甚至磁盘分区策略都会对