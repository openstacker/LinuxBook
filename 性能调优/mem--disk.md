# 内存、磁盘及网络

---

## 内存相关

内存是影响 Linux 性能的主要因素之一，通常出现的问题都与内存资源是否充足有关。

在 Linux 操作系统中，所以空余内存空间可以认为是 free + buffer +cache，当内存不够的时候，则需要将内存中的数据换出到磁盘上的 swap 区域中，而内存的换入换出则意味着大量的磁盘 IO 调用。按照经验数据，当空余内存小于 20% 的时候，将会出频繁的内存换入换出，此时整个系统的性能将会急剧下降，很多服务和应用的响应时间会被拉长，甚至出现 OOM 而杀死进程的情况。如果出现类似的情况则明显需要增加内存。

同时每个进程可使用的内存大小也是可以配置的，这样我们就可以防止出现某些异常的进程大量占用内存不进行释放而带来内存不足的问题，配置文件位于 /etc/security/limits.conf，如下的内容将会限制用户 bob 的进程仅可以使用 15KB 内存，用户组 alice 的进程只能使用 20KB 内存：

```shell
$ cat /etc/security/limits.conf
...
bob    hard    rss    15000
@alice hard    rss    20000
```

用户可以使用 ulimit -a 来查看自己的限制。

### OOM

当出现了内存不足的情况下，可能会导致 OOM 的情况，OOM 是 out of memory 的缩写，虽然 linux kernel 有很多的内存管理技巧来满足各种应用空间的内存需求，但是当系统配置不合理的时候，linux kernel 会运行非常缓慢并且在某个时间点分配 page frame 的时候遇到内存耗尽、无法分配的状况，此时系统会有两种处理情况：

1. 产生 kernel panic
2. 选择几个最“适合”的进程，启用 oom-killer，释放内存

Sysctl\_panic\_on\_oom 内核参数的配置就是针对这种情况下两种不同的动作而存在的，动态路径为 /proc/sys/vm/panic\_on\_oom。

如果选择第二种方式，那么就引入了一个新的问题，系统如何决定应该杀死哪个进程或哪几个进程呢？
参数 sysctl\oom\_kill\_allocating\_task 负责管理这种情形下的动作，为 0 表示杀掉内存占用最多的进程，为 1 则表示杀掉触发 OOM 的进程。

推荐参考链接 http://www.wowotech.net/memory_management/oom.html，这里提到了更多的细节的选择，包括 oom-killer 之后是否生成 dump 文件，有多个进程关联的时候如何选择等。

## 磁盘相关

当应用程序在执行过程中需要依赖磁盘 IO 而完成一系列动作的时候，磁盘本身的性能、服务器对磁盘使用的配置甚至磁盘分区策略都会对系统性能带来影响。

### 磁盘性能

衡量一块磁盘的性能最常见的标准就是磁盘转速，当然在出现了 SSD 硬盘之后转速的参数消失，直接反应为读写速率，实际上还有一些参数也会影响到应用或系统本身，比如最长写入延时等，虽然在单次的读写中并不会带来太大的问题，但在一个中大型的系统中这一类参数也会对系统的性能带来一定的影响。

### 服务器对磁盘的使用方式

在现代服务器中，常见的磁盘相关设备包括 raid 卡等，对于机械硬盘来说，raid0 无疑会带来性能的提升，而对于 SSD 硬盘来说，更快速的访问方式应该是直通方式，多种厂商的直通方式虽然名称和实现细节略有不同，但基本都是绕过了 raid 卡直接访问SSD硬盘以发挥磁盘本身的最大性能。

### 分区策略

在现代操作系统中，跨分区的数据访问一定会比同一分区的访问速率要更加缓慢，所以如果我们的应用程序涉及数据拷贝与同步等操作的时候，我们应该考虑磁盘的分区策略以及数据的放置位置。

同时对于 SSD 磁盘来说，由于闪存颗粒为 4K 的整数倍，所以我们应该对磁盘进行 4K 对齐，否则无法发挥磁盘的最大性能。

### 文件系统

对于 Linux 的 Ext3/4 来说，几乎在所有情况下都有所帮助的一个参数是关闭文件系统访问时间，Linux 的文件支持一个属性为 atime，表示最近的访问时间，意味着每当对文件进行访问的时候，底层文件系统必须记录这个时间戳，如果系统管理员很少使用 atime，禁用它可以减少磁盘访问时间。禁用这个特性的方法是，在 /etc/fstab 中添加 noatime 选项。

## 网络相关

网络调优基本体现在大量的内核参数中：

Net.ipv4.tcp\_keepalive\_time： 指定时间内如果某条 tcp 连接处于空闲状态，内核则会向对端发起探测以检测连接状态

Net.ipv4.tcp_keepalive_intvl： 内核针对 tcp 连接的 keepalive 间隔

Net.ipv4.tcp_keepalive_probes： 内核针对 tcp 连接 keepalive 的最大探测次数，超过该次数无响应则断开连接

Net.ipv4.tcp_max_syn_backlog： 内核针对每个端口的 tcp syn 队列长度，超过该值的 syn 请求将被丢弃

Net.ipv4.tcp_synack_retries： 内核针对某一 syn 请求的 ack 回应最大重传次数

Net.ipv4.tcp_retries： 内核针对某一 tcp 连接的最大重传次数

同时配合 iptables 也可以对服务器的网络活动进行大量的管理，以提高服务器的网络响应质量。

同时当服务器所提供的服务包含大量并发的时候，应该注意 ulimit 中所支持的最大线程数。